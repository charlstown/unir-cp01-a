pipeline {
    agent none
    options {
        skipDefaultCheckout(true) // Avoid default SCM checkout
    }
    stages {
        stage('Get Code') {
            agent any
            steps {
                sh '''
                whoami
                hostname
                '''
                // Configure git and clone the repository
                sh 'git config --global --add safe.directory /var/jenkins_home/workspace/O24/test-1'
                git 'https://github.com/charlstown/unir-cp01-a.git'

                // Stash project files for later stages
                stash includes: '**', name: 'project-files'
            }
            post {
                always {
                    cleanWs() // Clean workspace after this stage
                }
            }
        }

        stage('Testing and Analysis') {
            parallel {
                stage('Unit') {
                    agent { label 'agent-vi' }
                    environment {
                        PYTHONPATH = "/var/jenkins_home/workspace/cp_1.2/reto_1"
                    }
                    steps {
                        unstash 'project-files' // Retrieve project files
                        sh '''
                        echo "[UNIT TESTS AGENT]"
                        whoami
                        hostname
                        '''
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            // Run unit tests with coverage
                            sh 'python3 -m coverage run --branch --source=app --omit=app/__init__.py,app/api.py -m pytest --junitxml=result-unit.xml test/unit'
                        }
                        junit 'result-unit.xml' // Publish results immediately for pipeline color
                        stash includes: 'result-unit.xml', name: 'unit-test-results'
                    }
                    post {
                        always {
                            cleanWs() // Clean workspace
                        }
                    }
                }

                stage('REST') {
                    agent { label 'agent-vi' }
                    environment {
                        PYTHONPATH = "/var/jenkins_home/workspace/cp_1.2/reto_1"
                    }
                    steps {
                        unstash 'project-files' // Retrieve project files
                        sh '''
                        echo "[REST TESTS AGENT]"
                        whoami
                        hostname
                        '''
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            // Start Flask server
                            sh '''
                            export FLASK_APP=app/api.py
                            flask run --host=127.0.0.1 --port=5000 > flask.log 2>&1 &
                            echo $! > flask.pid
                            '''

                            // Wait for Flask to be ready
                            sh '''
                            echo "Waiting for Flask to be ready..."
                            for i in {1..10}; do
                                if curl -s http://127.0.0.1:5000 > /dev/null; then
                                    echo "Flask is up and running!"
                                    break
                                fi
                                sleep 1
                            done
                            '''

                            // Run REST tests
                            sh '''
                            python3 -m pytest --junitxml=result-rest.xml test/rest
                            '''
                        }
                        junit 'result-rest.xml' // Publish results immediately for pipeline color
                        stash includes: 'result-rest.xml', name: 'rest-test-results'

                        // Stop Flask server
                        sh '''
                        if [ -f flask.pid ]; then
                            kill $(cat flask.pid)
                            rm flask.pid
                        fi
                        '''
                    }
                    post {
                        always {
                            cleanWs() // Clean workspace
                        }
                    }
                }

                stage('Static') {
                    agent { label 'agent-jinx' }
                    steps {
                        unstash 'project-files' // Retrieve project files
                        sh '''
                        whoami
                        hostname
                        '''
                        // Run flake8
                        sh 'python3 -m flake8 --format=pylint --exit-zero --output-file=result-flake8.out app'

                        // Publish results immediately for pipeline color
                        recordIssues tools: [flake8(pattern: 'result-flake8.out')],
                                     qualityGates: [
                                         [threshold: 8, type: 'TOTAL', unstable: true],
                                         [threshold: 10, type: 'TOTAL', unhealthy: true]
                                     ]
                        stash includes: 'result-flake8.out', name: 'flake8-results'
                    }
                    post {
                        always {
                            cleanWs() // Clean workspace
                        }
                    }
                }

                stage('Security') {
                    agent { label 'agent-jinx' }
                    steps {
                        unstash 'project-files' // Retrieve project files
                        sh '''
                        echo "[SECURITY ANALYSIS AGENT]"
                        whoami
                        hostname
                        '''
                        // Run bandit
                        sh '''
                        bandit -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                        '''

                        // Publish results immediately for pipeline color
                        recordIssues tools: [pyLint(name: 'bandit', pattern: 'bandit.out')],
                                     qualityGates: [
                                         [threshold: 2, type: 'TOTAL', unstable: true],
                                         [threshold: 4, type: 'TOTAL', unhealthy: true]
                                     ]
                        stash includes: 'bandit.out', name: 'bandit-results'
                    }
                    post {
                        always {
                            cleanWs() // Clean workspace
                        }
                    }
                }
            }
        }

        stage('Performance') {
            agent { label 'agent-vi' }
            steps {
                unstash 'project-files' // Retrieve project files
                sh '''
                echo "[PERFORMANCE TESTS AGENT]"
                whoami
                hostname
                '''

                // Run performance tests
                sh '/opt/apache-jmeter-5.6.3/bin/jmeter -n -t test/jmeter/flask.jmx -f -l flask.jtl'

                stash includes: 'flask.jtl', name: 'performance-results'
                perfReport sourceDataFiles: 'flask.jtl' // Publish results immediately for pipeline color
            }
            post {
                always {
                    cleanWs() // Clean workspace
                }
            }
        }
    }
}
